{% extends "./base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ meta_title }}{% endblock %}
{% block meta_description %}{{ meta_description }}{% endblock %}
{% block canonical %}{{ canonical_url }}{% endblock %}

{% block content %}
<!-- ===== PRODUCT HERO ===== -->
<section class="product-hero d-flex align-items-center justify-content-center text-center text-white">
    <div class="container fade-up">
        <h1 class="fw-bold mb-3">Product Details</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-center mb-0">
                <li class="breadcrumb-item"><a href="{% url 'frontend:home' %}"
                        class="text-white text-decoration-none">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'frontend:product_list' %}"
                        class="text-white text-decoration-none">Products</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">Product Detail</li>
            </ol>
        </nav>
    </div>
</section>

<!-- ===== PRODUCT DETAIL ===== -->
<section class="product-detail py-5">
    <div class="container">
        <div class="row align-items-center g-5 fade-up">
            <!-- Product Image Gallery -->
            <div class="col-md-6">
                {% if product.featured_image %}
                <div class="main-img mb-3">
                    <img id="mainProductImg" src="{{ product.featured_image }}" class="img-fluid rounded-4 shadow-sm"
                        alt="{{product.name}}">
                </div>
                {% endif %}
                <div class="thumbs d-flex gap-2 justify-content-center">
                    {% for img in images %}
                    <img src="{{ img.image.url }}" class="thumb-img active rounded-3" alt="{{ img.alt_text }}">
                    {% endfor %}
                </div>
            </div>

            <!-- Product Info -->
            <div class="col-md-6">
                <h2 class="fw-bold mb-3">{{product.name}}</h2>
                <p class="text-muted mb-3">{{product.short_description}}</p>
                <h4 class="text-primary fw-semibold mb-3">â‚¦{{product.price|floatformat:0|intcomma}}
                    {% if product.is_each %}
                    <small class="text-muted fs-6">/ each</small>
                    {% endif %}
                </h4>

                <form onsubmit="addToCart(event, this, '{{ product.slug }}')">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="quantity" class="form-label fw-semibold">Quantity</label>
                        <input type="number" name="quantity" id="quantity" class="form-control w-25" value="1" min="1">
                    </div>
                    <button type="submit" class="btn btn-accent btn-lg px-4 mt-3" data-product-slug="{{ product.slug }}">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <span class="btn-text">Add to Cart</span>
                    </button>
                </form>

                <hr class="my-4">

                <ul class="list-unstyled text-muted small">
                    <li>âœ… 100% organic</li>
                    <li>ðŸšš Fast nationwide delivery</li>
                    <li>ðŸ’³ Secure payment options</li>
                </ul>
            </div>
        </div>

        <!-- Product Description -->
        <div class="mt-5 fade-up">
            <h4 class="fw-bold mb-3">Product Description</h4>
            <p class="text-muted">
                {{product.long_description}}
            </p>
        </div>
    </div>
</section>

<!-- ===== RELATED PRODUCTS ===== -->
<section class="related-products py-5 bg-light">
    <div class="container">
        <h3 class="fw-bold text-center text-primary mb-4 fade-up">Related Products</h3>

        <div class="swiper myRelatedSwiper fade-up">
            <div class="swiper-wrapper">
                <!-- Slide 1 -->
                {% for product in related_products %}
                <div class="swiper-slide" style="margin-right: 10px;">
                    <div class="card product-card">
                        <div class="img-wrap">
                            <img loading="lazy" src="{{ product.featured_image }}" alt="Seed bag product">
                        </div>
                        <div class="p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">{{product.name}}</h6>
                                    <!-- <h6 class="mb-1"><a href="{% url 'frontend:product_detail' product.slug %}">{{product.name}}</a></h6> -->
                                    <!-- <small class="text-muted">{{product.short_description}}</small> -->
                                    <a href="{% url 'frontend:product_detail' product.slug %}">View Details</a>
                                </div>

                                {% if product.has_discount %}
                                <div class="text-end">
                                    <div class="badge-discount">-{{product.sale_percent}}%</div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="fw-bold">â‚¦{{product.price|floatformat:0|intcomma}}</div>
                                    {% if product.has_discount %}
                                    <small
                                        class="text-muted text-decoration-line-through">â‚¦{{product.old_price|floatformat:0|intcomma}}</small>
                                    {% endif %}
                                </div>
                                <div>
                                    <!-- <button class="btn btn-sm btn-outline-secondary me-1"><i
                                            class="bi bi-heart"></i></button> -->
                                    <button class="btn btn-sm btn-primary-custom">Add to Cart</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="swiper-pagination mt-3"></div>
        </div>
    </div>
</section>

<!-- JSON-LD Schema for SEO -->
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product.name|escape }}",
  "image": "{% if product.image %}{{ request.scheme }}://{{ request.get_host }}{{ product.image.url }}{% endif %}",
  "description": "{{ product.description|truncatewords:40|escape }}",
  "sku": "{{ product.id }}",
  "brand": {
    "@type": "Organization",
    "name": "Fabstar Limited"
  },
  "category": "{{ product.category.name|escape }}",
  "offers": {
    "@type": "Offer",
    "url": "{{ request.scheme }}://{{ request.get_host }}{{ product.get_absolute_url }}",
    "priceCurrency": "NGN",
    "price": "{{ product.price }}",
    "availability": "https://schema.org/InStock",
    "seller": {
      "@type": "Organization",
      "name": "Fabstar Limited"
    }
  }
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'frontend:home' %}"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Products",
      "item": "{{ request.scheme }}://{{ request.get_host }}{% url 'frontend:product_list' %}"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "{{ product.name|escape }}",
      "item": "{{ request.scheme }}://{{ request.get_host }}{{ product.get_absolute_url }}"
    }
  ]
}
</script>

{% endblock %}
{% block extra_js %}
<script>
    // ===== PRODUCT IMAGE SWITCH =====
    document.addEventListener('DOMContentLoaded', () => {
        const thumbs = document.querySelectorAll('.thumb-img');
        const mainImg = document.getElementById('mainProductImg');

        if (thumbs.length && mainImg) {
            thumbs.forEach(thumb => {
                thumb.addEventListener('click', () => {
                    thumbs.forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                    mainImg.src = thumb.src;
                });
            });
        }

        // ===== SWIPER FOR RELATED PRODUCTS =====
        if (document.querySelector('.myRelatedSwiper')) {
            new Swiper('.myRelatedSwiper', {
                slidesPerView: 1.5,
                spaceBetween: 15,
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                },
                breakpoints: {
                    576: { slidesPerView: 2 },
                    992: { slidesPerView: 4 },
                },
            });
        }
    });

</script>
{% endblock %}