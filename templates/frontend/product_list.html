{% extends "./base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ meta_title }}{% endblock %}
{% block meta_description %}{{ meta_description }}{% endblock %}

{% block content %}
<!-- ===== HERO / BANNER ===== -->
<section class="services-hero d-flex align-items-center justify-content-center text-center text-white">
    <div class="container fade-up">
        <h1 class="display-4 fw-bold mb-2 fade-up">Our Prducts</h1>
        <p class="lead fade-up" style="animation-delay: 0.3s;">
            Fresh Agricultural products, healthy livestock, and safe gas retail services across Nigeria.
        </p>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-center mb-0">
                <li class="breadcrumb-item"><a href="{% url 'frontend:home' %}"
                        class="text-white text-decoration-none">Home</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">Services</li>
            </ol>
        </nav>
    </div>
</section>

<!-- ===== PRODUCT SECTION ===== -->
<section class="products-section py-5">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4 fade-up">
            <h2 class="fw-bold text-primary mb-0">Explore Our Products</h2>
            <!-- Sorter -->
            <div class="sorter">
                <label for="sortCategory" class="me-2 fw-semibold">Sort by:</label>
                <select id="sortCategory" class="form-select">
                    <option value="all">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat.slug }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- PRODUCT GRID -->
        <div class="row g-4" id="productGrid">

            <!-- Product 1 -->
            {% for product in products %}
            <div class="col-md-6 col-lg-3 fade-up" data-category="{{ product.category.slug }}">
                <div class="card product-card">
                    <div class="img-wrap">
                        <img loading="lazy" src="{{ product.featured_image }}" alt="Seed bag product">
                    </div>
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">{{product.name}}</h6>
                                <!-- <h6 class="mb-1"><a href="{% url 'frontend:product_detail' product.slug %}">{{product.name}}</a></h6> -->
                                <!-- <small class="text-muted">{{product.short_description}}</small> -->
                                <a href="{% url 'frontend:product_detail' product.slug %}">View Details</a>
                            </div>
                            {% if product.has_discount %}
                            <div class="text-end">
                                <div class="badge-discount">-{{product.sale_percent}}%</div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="fw-bold">₦{{product.price|floatformat:0|intcomma}}</div>

                                {% if product.has_discount %}
                                <small
                                    class="text-muted text-decoration-line-through">₦{{product.old_price|floatformat:0|intcomma}}</small>
                                {% endif %}
                            </div>
                            <div>
                                <!-- <button class="btn btn-sm btn-outline-secondary me-1"><i
                                        class="bi bi-heart"></i></button> -->
                                <button class="btn btn-sm btn-primary-custom">Add to Cart</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>


<!-- Structured Data for Products -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Fabstar Limited Products",
  "itemListElement": [
    {% for product in products %}
    {
      "@type": "Product",
      "name": "{{ product.name|escape }}",
      "image": "{% if product.image %}{{ request.scheme }}://{{ request.get_host }}{{ product.image.url }}{% endif %}",
      "description": "{{ product.description|truncatewords:25|escape }}",
      "url": "{{ request.scheme }}://{{ request.get_host }}{{ product.get_absolute_url }}",
      "category": "{{ product.category.name|escape }}",
      "offers": {
        "@type": "Offer",
        "priceCurrency": "NGN",
        "price": "{{ product.price }}",
        "availability": "https://schema.org/InStock"
      }
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  ]
}
</script>
{% endblock %}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const select = document.getElementById('sortCategory');
        const grid = document.getElementById('productGrid');
        const cards = grid.querySelectorAll('[data-category]');
        const urlParams = new URLSearchParams(window.location.search);
        const currentCategory = urlParams.get('category') || 'all';

        console.log(select)
        // Set the dropdown to the current category from URL
        select.value = currentCategory;

        // Function to filter products
        function filterProducts(category) {
            cards.forEach(card => {
                const cardCat = card.getAttribute('data-category').toLowerCase();
                card.style.display = (category === 'all' || category === cardCat) ? '' : 'none';
            });
        }

        // Apply initial filter on page load
        filterProducts(currentCategory);

        // Handle dropdown changes
        select.addEventListener('change', function () {
            const selected = this.value;

            // Filter products
            filterProducts(selected);

            // Update URL without reloading the page
            const newUrl = selected === 'all'
                ? window.location.pathname
                : `${window.location.pathname}?category=${selected}`;

            window.history.pushState({ category: selected }, '', newUrl);
        });

        // Handle browser navigation (Back / Forward)
        window.addEventListener('popstate', function (e) {
            const category = e.state ? e.state.category : 'all';
            select.value = category;
            filterProducts(category);
        });
    });
</script>

{% endblock %}